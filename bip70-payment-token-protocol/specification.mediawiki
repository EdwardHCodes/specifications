<pre>
  Title: BIP70 Payment Token Protocol
  Author: Shammah Chancellor <email@here.com>
          Harry Barber <harrybarber@protonmail.com>
  Status: Draft
  Created: 2019-11-15
  License: MIT
</pre>

== Introduction ==

=== Abstract ===

We introduce a general payment protocol which allows services to restrict access to resources until an appropriate payment is provided.

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [[https://www.ietf.org/rfc/rfc2119.txt|RFC 2119]]. 

=== Motivation ===

Monetization of goods over the internet often involves the restriction of specific resources via some form of paywall. As a result, much of web design involves architecting complex authorization schemes involving third party payment processors. 

Bitcoin allows payments across the internet without the need for trusted intermediaries and the [[https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki|BIP70 Payment Protocol]] provides an extra layer of customer assurance during payments.

A standardized protocol for paid authorization to specific resources would provide merchants with a pluggable way to monetize their services.

== Specification ==

The protocol sits ontop of HTTP and makes use of REST API semantics. It extends the BIP70 protocol and, as such, prior knowledge of it is recommended.

It is to be noted that BIP70 must be suplemented with [[https://github.com/bitcoin/bips/blob/master/bip-0071.mediawiki|BIP71]] and [[https://github.com/bitcoin/bips/blob/master/bip-0072.mediawiki|BIP72]], and that both take on a slightly altered form<ref>The headers are altered as described https://lists.linuxfoundation.org/pipermail/bitcoin-ml/2017-August/000177.html</ref> for Bitcoin Cash. We refer to this this collection of BIPs as BIP70 from hereon after.

The protocol's messages are encoded via [[https://developers.google.com/protocol-buffers|Google's Protocol Buffers]], authenticated using [[https://tools.ietf.org/html/rfc5280|X.509 certificates]], and communicated over HTTP/HTTPS.

=== Overview ===

At the most general level the protocol can be decomposed into three distinct round-trips:

1. Client sends initial request for a guarded resource, server responds with a BIP70 payment request.
2. Client sends a POST containing payment, server responds with a BIP70 payment acknowledgement and a token.
3. Client resends the initial request with the token attach, server grants access to the guarded resource.

=== Sequence ===

==== 1. Initial Request ====

The client requests access to some guarded HTTP resource. The query string of the request MUST NOT include <code>code</code> and the <code>Authorization</code> header MUST NOT be present. If either of these are present the server MUST assume that the client is attempting authorize itself and process the request as described in [3. Authorized Request](#3.-authorized-request).

There are no additional restriction placed on the HTTP request.

A successful request MUST be responded to with status code <code>402</code> (*Payment Required*) and the <code>PaymentRequest</code> message defined in the [[PaymentDetails/PaymentRequest|https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki#PaymentDetailsPaymentRequest]] section of BIP70.

```protobuf
message PaymentDetails {
        optional string network = 1 [default = "main"]; // "main" or "test"
        repeated Output outputs = 2;        // Where payment should be sent
        required uint64 time = 3;           // Timestamp; when payment request created
        optional uint64 expires = 4;        // Timestamp; when this request should be considered invalid
        optional string memo = 5;           // Human-readable description of request for the customer
        optional string payment_url = 6;    // URL to send Payment and get PaymentACK
        optional bytes merchant_data = 7;   // Arbitrary data to include in the Payment message
}

message PaymentRequest {
        optional uint32 payment_details_version = 1 [default = 1];
        optional string pki_type = 2 [default = "none"];  // none / x509+sha256 / x509+sha1
        optional bytes pki_data = 3;                      // depends on pki_type
        required bytes serialized_payment_details = 4;    // PaymentDetails
        optional bytes signature = 5;                     // pki-dependent signature
}
```

The server MUST populate <code>merchant_data</code> field of the <code>PaymentDetails</code> message, the exact details of this data is left for future specification and are inconsequential to the main flow of the protocol. Post-payment, this data will be signed by the server providing a "proof-of-payment" token to the client in order to authenticate metadata uploads.

==== 2. Payment and Token Issuance ====

The client sends the payment in the body of a POST request to the <code>payment_url</code> specified in the <code>PaymentDetails</code> and the server responds with a payment acknowledgement message. This is performed in accordance with BIP70. 

The <code>merchant_data</code> in the clients `Payment` message MUST be equal to the <code>merchant_data</code> in the servers <code>PaymentDetails</code>. Note here that malicious clients MAY modify the <code>merchant_data</code>, and hence it is RECOMMENDED that it is authenticated in some way (for example, signed with a merchant-only key). 

```protobuf
message Payment {
        optional bytes merchant_data = 1;  // From PaymentDetails.merchant_data
        repeated bytes transactions = 2;   // Signed transactions that satisfy PaymentDetails.outputs
        repeated Output refund_to = 3;     // Where to send refunds, if a refund is necessary
        optional string memo = 4;          // Human-readable message for the merchant
}
```

In addition to the BIP70 procedure, the server generates a token string using the following process:

# Extract the <code>merchant_data</code> from the <code>Payment</code> message.
# Perform HMAC SHA256 with a private secret to yield the raw token.
# Encode the raw token using URL safe base64.

This response MUST have status code <code>202</code> and include both:

* A <code>Location</code> header <code>{resource path}?code={token string}</code>.
* A <code>Authorization</code> header <code>POP {token string}</code>.

It is RECOMMENDED that the <code>merchant_data</code> is chosen such that the `resource path` is derivable from it - avoiding session state.

==== 3. Authorized Request ====

The client reconstructs the initial request and MUST include either the code provided in the ... TODO

It is RECOMMENDED that, if the client aims to PUT or POST a payload to the server, the body SHOULD be included in this final request rather than the initial request to avoid repeated transmission or excess session state.

== Rationale ==

=== BIP 70 ===

The BIP70 payment protocol is a widely adopted standard. Extending it in this way allows wallet developers to easily integrate the protocol with minimal work.

=== Statelessness ===

The protocol has been designed with statelessness in mind. By using tokens it requires no extra state in addition to that needed from BIP70.

== Footnotes ==

<references />

== References ==

* [[https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki|BIP70 Payment Protocol]]
* [[https://github.com/bitcoin/bips/blob/master/bip-0071.mediawiki|BIP71 Payment Protocol MIME types]]
* [[https://github.com/bitcoin/bips/blob/master/bip-0072.mediawiki|BIP72 bitcoin: uri extensions for Payment Protocol]]
* [[https://developers.google.com/protocol-buffers|Google's Protocol Buffers]]
* [[https://www.ietf.org/rfc/rfc2119.txt|RFC 2119 - RFC Key Words]]
* [[https://tools.ietf.org/html/rfc5280|RFC 5280 - X.509 Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile]]
